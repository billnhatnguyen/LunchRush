<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Lunch Rush</title>
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>

    </head>

    <style>
        /* Simple just housekeeping work */ 
        body{
            margin:0;
            display: flex; 
            justify-content: center;
            align-items: center; 
            height: 100vh; 
            background-color: #f0f0f0;
            font-family:'Press Start 2P', cursive;
            overflow: hidden;
        }
        /* This will be where we'll "draw" our game*/
        canvas {
            border:4px solid#333;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            background-color: #6a6a6a;
        }

        /* This will be our overall container */
        #gameContainer { 
            position: relative; 
            }.game-ui {
                position: absolute;
                color: #fff;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
                font-size: 18px;
                z-index: 10;
            }
            /* Our game numbers*/
            #pointsScore {
                top: 25px; 
                left: 20px;
                font-size: 12px

            }

            #healthMeter{
                top:30px; 
                left: 150px;
                color: lightgreen; 
                font-size: 10px
            }

            #streak{
                top:25px; 
                left: 300px;
                color: lightyellow;
                font-size: 12px
            }

            #gameOver{
                font-size: 50px;
                color: darkred;
                display: none; 
                top: 50%; 
                left: 50%;
                transform: translate(-50%, -50%);
            }
            #gameOver button {
                background-color: #4CAF50;
                border: none;
                color: white;
                padding: 15px 32px;
                font-size: 16px;
                margin-top: 20px;
                cursor: pointer;
                border-radius: 8px;
                font-family: 'Press Start 2P', cursive;
                }
    </style>

    <body>
        <!-- This will make our scores variables for later-->
        <div id="gameContainer">
            <div id="pointsScore" class="game-ui">Score:0 </div>
            <div id="healthMeter" class="game-ui">Health:100 </div>
            <div id="streak" class="game-ui">Streak:0</div>
            <div id="gameOver" class="game-ui"> 
                Game Over! <br> 
                <button onclick="resetGame()">Play Again</button>
            </div>     

        <!-- This will be our block for our game our JS :) -->
        <script>
            function setup(){
                let canvas = createCanvas(400,600);
                canvas.parent('gameContainer');
                pixelDensity(1);
                textAlign(CENTER);
                textSize(16);
                noStroke();

                document.addEventListener('touchmove', function(event) {
                    if (!gameOver && !paused) event.preventDefault();
                }, { passive: false });
                
            }

            //Our JS global variables used in our game
            let frames = 0; 
            let spawnTime = 60; 
            let itemSpeed = 2; 
            let beltOffset = 0; 
            let beltSpeed = 2; 
            let score = 0; 
            let health = 100; 
            let streak = 0; 
            let multi = 1; 
            let gameOver = false;
            let items = []; 
            let paused = false; 
            let convayorBelt;
            let convayorBeltHeight = 33;
            let convayorBeltWidth = 100; 
            let backgroundImg;
            
            const itemType = [
                {name: "Salad", class: "Healthy", points: 10, color: "green", img: null, radius: 30},
                {name: "Burger", class: "Unhealthy", points: 5, color: "brown", img: null, radius: 30},
            ];

            function preload() {
                backgroundImg = loadImage('assets/background.png');
                const burgerImage = loadImage('assets/burger.webp');
                const burger = itemType.find(item => item.name === "Burger");
                convayorBelt = loadImage('assets/rail.png')

                if (burger) {
                    burger.img = burgerImage;
                }
            }

            //Will be our item class for the individual items
            class Item { 
                constructor(type){
                    this.x = width /2; 
                    this.y = -type.radius; 
                    this.name = type.name; 
                    this.kind = type.class; 
                    this.color = type.color; 
                    this.points = type.points
                    this.radius = type.radius;
                    this.img = type.img;
                    this.swipe = null;
                    this.swipeSpeed = 15;
                    this.swipeProgress = 0;
                    this.swipeDistance = 200;
                }
            }


            function draw(){
                //If its game over well return
                if (gameOver) return; 

                if (paused) {
                    background(150);
                    stroke(100);
                    strokeWeight(2);
                    for (let y = beltOffset; y <= height + 25; y += 25) {
                        line(0, y, width, y);
                    }
                    fill(0, 0, 0, 120);
                    rect(0, 0, width, height);
                    fill(255);
                    textSize(16);
                    text('PAUSED', width / 2, height / 2);
                    textSize(16);
                    return;
                }

                //This is our convayor belt
                image(backgroundImg, 0, 0, width, height);
                // stroke(100);
                // strokeWeight(2);
                // for(let y = beltOffset; y<height; y+=25){s
                //     line(0, y, width, y);
                // }
                // beltOffset = (beltOffset + beltSpeed) % 20; 
                for(let y = beltOffset - convayorBeltHeight; y < height + convayorBeltHeight; y += convayorBeltHeight){
                    image(convayorBelt, width/2 - convayorBeltWidth/2 + 2, y, convayorBeltWidth, convayorBeltHeight);
                }
                
                // Update belt offset for continuous scrolling
                beltOffset = (beltOffset + itemSpeed) % convayorBeltHeight;

                //Item maker timed.
                frames++; 
                if(frames >= spawnTime){
                    spawnItems();
                    frames = 0;
                }

                //Move and draw our items
                for(let i =items.length -1; i>=0; i--){
                    let item = items[i];
                    
                    if(!item.swipe){
                        item.y += itemSpeed;
                    } else {
                        if (item.swipe == "left"){
                            item.x -= item.swipeSpeed;
                        }
                        if (item.swipe == "right"){
                            item.x += item.swipeSpeed;
                        }
                        item.swipeProgress += item.swipeSpeed;

                        if(item.swipeProgress > item.swipeDistance){
                            items.splice(i,1);
                            continue;
                        }
                    }


                    //Placeholder for our items
                    if(item.img){
                        image(item.img, item.x - item.radius, item.y - item.radius, item.radius * 2, item.radius * 2);  
                    }else{
                        fill(items[i].color);
                        ellipse(items[i].x, items[i].y, item.radius, item.radius);
                    }
                    fill(0);
                    text(item.name, item.x, item.y + 5);
                    
                    //Tacks off HP for when items fall off our belt
                    if(items[i].y > height){
                        items.splice(i,1);
                        health -= 10; 
                        streak = 0 ; 
                        updateUI();
                        isGameOver();
                    }

                    updateUI();

                    if (frameCount %120 == 0){
                        itemSpeed = Math.min(itemSpeed + 0.2, 100000);
                        beltSpeed = Math.min(beltSpeed + 0.1, 6);
                        spawnTime = Math.max(20, spawnTime -2);
                    }

                }

            }

            
            //Items
            function spawnItems(){
                let randomFood = random(itemType);
                items.push(new Item(randomFood));
            }

            //Our swiping mechanism
            function swiper(){
                if(paused){
                    background(150);
                    stroke(100);
                    strokeWeight(2);
                    fill(0,0,0,120);
                    rect(0,0,width,height);
                    fill(255);
                    textSize(16);
                    text("PAUSED", width/2, height/2);
                    return false;
                }
                if (gameOver){
                    return false; 
                }

                for (let i = items.length -1; i>= 0; i--){
                    const item = items[i];
                    if (item.swipe){
                        continue;
                    }
                    if(item.y < -50 || item.y > height + 50){
                        continue; 
                    }
                    
                    const distanceX = mouseX - item.x; 
                    const distanceY = mouseY - item.y; 
                    const distance = Math.sqrt (pow(distanceX, 2) + pow(distanceY, 2))
                    
                    if(distance <= item.radius + 10){
                            const changeX = mouseX - pmouseX;
                            
                            if (changeX < -5){
                                processItem(item, "left");
                                break;
                            }
                            if (changeX > 5){
                                processItem(item, "right");
                                break;
                            }
                    }
                }
            }

            //Simple if we swip call our swiper
            function mouseDragged() {
                return swiper();
            }
            function touchMoved(){
                return swiper();
            }


            function getMulti(){
                if(streak >= 10 ){
                    return 2; 
                }
                if(streak > 5) {
                    return 1.5;
                }
                else{
                return 1;
                }
            }

            //Our game's logic
            function processItem(item, direction, index){
                item.swipe = direction; 
                const correctSwipe = (direction == "left" && item.kind == "Healthy") || (direction == "right" && item.kind == "Unhealthy"); 
                
                if (correctSwipe){
                    streak++; 
                    const points = Math.round(item.points *getMulti());
                    score += points; 

                    if (item.kind == "Healthy"){
                        health = Math.min(100, health + 5);
                    }
                }else{
                    streak = 0;
                    health -= 10;
                    score = Math.max(0, score - 5);
                }
                    updateUI();
                    isGameOver();
            }
            
            //Arrow Control
            function keyPressed(){
                if (keyCode == 32){
                    paused = !paused;
                    document.getElementById('pause').innerText = paused ? 'Resume' : 'Pause';
                }
                if (gameOver){
                    return;
                }
                if (keyCode == LEFT_ARROW || key == 'a' || key == 'A') arrowSwipe("left");
                if (keyCode == RIGHT_ARROW || key == 'd' || key == 'D') arrowSwipe("right");       
            }

        function arrowSwipe(direction) {
            if (items.length === 0) return;
            let bot = null;
            let maxY = -Infinity;
            let botIndex = -1;
            for (let i = 0; i < items.length; i++) {
                if (items[i].swipe) continue;
                if (items[i].y < -items[i].radius || items[i].y > height + items[i].radius) continue;
                if (items[i].y > maxY) {
                    maxY = items[i].y;
                    bot = items[i];
                    botIndex = i;
                }
            }
            if (bot) {
                processItem(bot, direction);
            }
        }

            //UI changes based on gameplay
            function updateUI(){
                document.getElementById("pointsScore").innerText = `Score:${score}`;
                document.getElementById("healthMeter").innerText = `Health:${health}`;
                document.getElementById("streak").innerText = `Streak:${streak}`;
            }

            //GameState
            function isGameOver(){
                if(health <= 0){
                    gameOver = true; 
                    document.getElementById('gameOver').style.display = 'block';
                    noLoop();
                }
            }

            //Reset Game
            function resetGame(){
                frames = 0; 
                 spawnTime = 60; 
                 itemSpeed = 2; 
                 beltOffset = 0; 
                 beltSpeed = 2; 
                 score = 0; 
                 health = 100; 
                 streak = 0; 
                 multi = 1; 
                 gameOver = false;
                 items = []; 
                document.getElementById('gameOver').style.display = 'none';
                updateUI();
                loop();
            }

        </script>
    </body>
</html>